<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerar Controller</title>
    <style>
        .container{
            display:flex;
        }
        textarea{
            height: 45vh;
            display: block;
            width: 80vw;
        }
        label{
            display: block;
        }
    </style>
</head>
<body>
    <label for="solution">Digite o nome da Solution :</label>
    <div class="container">
        <input width="400px" id="solution">
    </div>
    <label for="area">Digite o nome da Area :</label>
    <div class="container">
        <input width="400px" id="area">
    </div>
    <label for="controlador">Digite o nome controlador :</label>
    <div class="container">
        <input width="400px" id="controlador">
    </div>
    <label for="classe">Nome Classe Principal</label>
    <div class="container">
        <input width="400px" id="classe">
    </div>

    <label for="entrada">Cole a classe C# aqui</label>
    <div class="container">
        <textarea height="50vh" id="entrada"></textarea>
    </div>
    <button onclick="gerarArquivoController()">Formatar</button>

    <label for="saida">Resultado Resx</label>
    <div class="container">
        <textarea height="50vh" id="saida"></textarea>
    </div>

<script>

function Tipo(tipo, nome){
        this.decimalNullAble = "decimal?";
        this.intNullAble = "int?";
        this.string = "string";
        this.int = "int";
        this.bool = "bool";

        Tipo.prototype.decimalNullAble = () => this.decimalNullAble;
        Tipo.prototype.intNullAble = () => this.intNullAble;
        Tipo.prototype.string = () => this.string;
        Tipo.prototype.int = () => this.int;
        Tipo.prototype.bool = () => this.bool;
    }

var TiposCSharp = {
    decimalNullAble : "decimal?",
    intNullAble : "int?",
    string : "string",
    int : "int",
    bool: "bool",
}

function Propriedade(tipo, nome){
    this.tipo = tipo;
    this.nome = nome;

    Propriedade.prototype.Tipo = () => this.tipo;
    Propriedade.prototype.Nome = () => this.nome;
}

function Dados(Area,Solution,ControllerName, ClassePrincipal){
    this.Area = Area;
    this.Solution = Solution;
    this.ControllerName = ControllerName;
    this.ClassePrincipal = ClassePrincipal;

    Dados.prototype.Area = () => Area;
    Dados.prototype.Solution = () => Solution;
    Dados.prototype.ControllerName = () => ControllerName;
    Dados.prototype.ClassePrincipal = () => ClassePrincipal;
}

function apenasUnicos(valor, indice, array){
    return array.indexOf(valor) == indice;
}

function retornaTiposUnique(lista){

    var listaTipos = [];
    lista.forEach( item => {
        var tipo = item[tipo];
        var naoIncluiTipo = !listaTipos.includes(tipo);

        if(naoIncluiTipo){
            listaTipos.push(tipo);
        } 
    });

    return listaTipos;
}

function gerarMetodosValidar(listaPropriedades){
    
    var tiposContidos = retornaTiposUnique(listaPropriedades);
    var Tipos = new Tipo();
    var saida = "";

    if(tiposContidos.includes(Tipos.string)){
        saida += `
        private void ValidaStringDoViewModel(string texto, string mensagemEhNulo, bool contemValidacaoTamanhoMaximo = true, int tamanhoMaximo = 0, string mensagemTamanhoMaximo = "")
        {
            if (string.IsNullOrWhiteSpace(texto))
            {
                this.ModelState.AddModelError(string.Empty, mensagemEhNulo);
            }
            else if (contemValidacaoTamanhoMaximo && texto.Length > tamanhoMaximo)
            {
                this.ModelState.AddModelError(string.Empty, mensagemTamanhoMaximo);
            }
        }
        `;
    }

    if(tiposContidos.includes(Tipos.intNullAble)){
        saida += `
        private void ValidaIntNullableLookUpObrigatorioViewModel(int? numeroNullAble, string mensagemObrigatorio)
        {
            if (!numeroNullAble.HasValue)
            {
                this.ModelState.AddModelError(string.Empty, mensagemObrigatorio);
            }
        }
        `;
    }

    if(tiposContidos.includes(Tipos.decimalNullAble)){
        saida += `
        private void ValidaDecimalMinMax(decimal? min, decimal? max, string mensagemValorMinMaior)
        {
            bool valoresNaoPreenchidos = !(min.HasValue && max.HasValue);
            if (valoresNaoPreenchidos)
            {
                return;
            }

            bool valorMinimoMaior = min.Value > max.Value;
            if (valorMinimoMaior)
            {
                this.ModelState.AddModelError(string.Empty, mensagemValorMinMaior);
            }

        }
        `;
    }

    return saida;
}

function getNamespace(classe){

    var dados = new Dados();
    var linhas = classe.split("\n");

    for (let indice = 0; indice < linhas.length; indice++) {

        var linha = linhas[indice]; 
        var haNamespace = linha.indexOf("namespace") != -1;

        var haClassName = linha.indexOf("class") != -1;

        if(haNamespace){
            var linhaNamespace = linha.trimLeft().split(".");

            var solutionName = linhaNamespace[0].split(" ")[1];
            var areaName = linhaNamespace[3];
            var controllerName = linhaNamespace[5];

            dados.Area = areaName;
            dados.Solution = solutionName;
            dados.ControllerName = controllerName.replace("{", "");

        }else if(haClassName){
            var mainClassName = linha.trimLeft().split(" ")[2];
            dados.ClassePrincipal = mainClassName;
            return dados;
        }
        
    }

    return dados;
}

function gerarArquivoController(){
    var classeName = classe.value;
    var classeConteudo = entrada.value;
    var dados = getNamespace(classeConteudo);
    
    var areaName = dados.Area;
    var controllerName = dados.ControllerName;
    var solutionName = dados.Solution;

    var listaPropriedades = getListProps(classeConteudo);

    var textoSaida = "";

    textoSaida += geraNamespace(solutionName, areaName, controllerName);
    textoSaida += gerarControlador(controllerName);
    textoSaida += gerarRead(controllerName, classeName);
    textoSaida += gerarInsert(controllerName, classeName);
    textoSaida += gerarMetodosValidar(listaPropriedades);
    textoSaida += fecharArquivo();

    saida.value = textoSaida;
}

function getListProps(classe){

    var listaProps = [];

    var linhasClasse = classe.split("\n");

    for(var indice =0 ; indice < linhasClasse.length; indice++){
        var linha = linhasClasse[indice];
        var linha = linha.trimLeft();

        var naoContemPublic = linha.indexOf("public") == -1;
        var contemClass = linha.indexOf("class") != -1;

        if(naoContemPublic || contemClass){
            continue;
        }else{

            var propType = linha.split(" ")[1];
            var propName = linha.split(" ")[2];

            var itemProp = new Propriedade(propType, propName);

            listaProps.push(itemProp);
        }
    }

    return listaProps;
}

function geraNamespace(solutionName, areaName, controllerName){
    var texto = `
    using Universal.Web.Mvc.Extensions;
    using Universal.Web.Telerik.Mvc5.Extensions;

    namespace Universal.Tois.${solutionName}.Web.Areas.${areaName}.Controllers
    {
        #if !DEBUG
            [Authorize( Roles = "${controllerName}" )]
        #endif
    `;

    return texto;
}

function gerarControlador(NomeController){  
    var arquivoControllador =  
        `\n
    public class ${NomeController}Controller : ToisController {\n

        public I${NomeController}AppService i${NomeController}AppService { get;}

        public ${NomeController}Controller(I${NomeController}AppService i${NomeController}AppService)
        {
            i${NomeController}AppService = i${NomeController}AppService;
        }

        public ActionResult Index(){
            return View();
        }
    `

    return arquivoControllador;
}

function gerarRead(controllerName, classeName){

    var texto = `
        public JsonResult Read${classeName}([DataSourceRequest] DataSourceRequest request, ${controllerName}FilterViewModel filtrosViewModel)
        {
            ${controllerName}FilterViewModelTO filtrosTO = (${controllerName}FilterViewModelTO) filtrosViewModel;

            filtrosTO.PagingParameterTO = new PagingParameterTO(request.Page, request.PageSize);

            TratarModelo(filtrosTO);

            ValidationResult<PagingResult<${controllerName}ViewModel>> validationResultViewModel = new ValidationResult<PagingResult<${controllerName}ViewModel>>();
            validationResultViewModel.Result = new PagingResult<${controllerName}ViewModel>();
            ValidationResult<PagingResult<${controllerName}TO>> validationPaging${controllerName}TO = i${controllerName}AppService.GetLista${controllerName}(filtrosTO);
            IEnumerable<${controllerName}TO> lista${controllerName}TO = validationPaging${controllerName}TO.Result.DataSource;

            bool sucessoAoBuscarDados = validationPaging${controllerName}TO.IsValid;
            if (sucessoAoBuscarDados)
            {
                bool listaPreenchida = listaNegociacaoTO != null;
                if (listaPreenchida)
                {
                    validationResultViewModel.Result.DataSource = lista${controllerName}TO.Select(to => (${controllerName}ViewModel) to).ToList();
                    validationResultViewModel.Result.Total = validationPagingPolitica${controllerName}TO.Result.Total;
                }
                else
                {
                    validationResultViewModel.ValidationResultToModelState(ModelState);
                }
            }

            return Json(validationResultViewModel.ToDataSourceResult(request, ModelState), JsonRequestBehavior.AllowGet);
        }`;

    return texto;
}
    
function gerarInsert(controllerName, classeName){
    var texto = `
        public JsonResult Inserir${classeName}([DataSourceRequest] DataSourceRequest request, ${controllerName}ViewModel viewModel)
            {
                ${controllerName}TO to = (${controllerName}TO) viewModel;
                ValidarModelTO(to);

                if (ModelState.IsValid)
                {
                    ValidationResult validation = i${controllerName}AppService.Inserir${controllerName}(to);

                    bool fracassoAoInserir = !validation.IsValid;
                    if (fracassoAoInserir)
                    {
                        validation.ValidationResultToModelState(this.ModelState);
                    }
                    else
                    {
                        viewModel = (${controllerName}ViewModel) to;
                    }
                }

                return Json(new[] { viewModel }.ToDataSourceResult(request, this.ModelState));
            }
    `

    return texto;
}

function gerarValidar(classe, controladorName, areaName){

    var listaClassePropsTipoName = getListProps(classe);

    var texto = `
  
        private void ValidarModelTO(${controladorName}TO to)
        {
            ValidaStringDoViewModel(
                texto: to.${propName},
                mensagemEhNulo: App_GlobalResources.${areaName}.${controladorName}.msgCampo${propName}Obrigatorio,
                tamanhoMaximo: 50,
                mensagemTamanhoMaximo: App_GlobalResources.${areaName}.${controladorName}.msgCampo${propName}TamanhoMaximo
             );

            ValidaDecimalMinMax(
                min: viewModel.PrecoMinimo,
                max: viewModel.PrecoMaximo,
                mensagem${propName}rMinMaior: App_GlobalResources.${areaName}.${controladorName}.msg${propName}MinMaior);

            ValidaIntNullableLookUpObrigatorioViewModel(
                numeroNullAble: viewModel.AreaProdutorCodigo,
                mensagemObrigatorio: App_GlobalResources.${areaName}.${controladorName}.msg${propName}Obrigatorio
            );

            ValidaStringNullAble(
                campoString: viewModel.${propName},
                mensagemObrigatorio: App_GlobalResources.${areaName}.${controladorName}.msg${propName}Obrigatorio
            );

        }
        private void ValidaStringNullAble(string campoString, string mensagemObrigatorio, bool contemValidacaoTamanhoMaximo = false, string mensagemTamanhoInvalido = "", int tamanhoMaximo = 0)
        {
            if (string.IsNullOrWhiteSpace(campoString))
            {
                this.ModelState.AddModelError(string.Empty, mensagemObrigatorio);
            }

            if (contemValidacaoTamanhoMaximo)
            {
                bool tamanhoInvalido = campoString.Length > tamanhoMaximo;

                if (tamanhoInvalido)
                {
                    this.ModelState.AddModelError(string.Empty, mensagemTamanhoInvalido);
                }
            }
        }
       
       

        
    `
}
   
function fecharArquivo(){
    var textoSaida = "}\n   }";
    return textoSaida;
}

</script>
</body>
</html>