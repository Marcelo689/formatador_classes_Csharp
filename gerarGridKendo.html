<html>
    <head>
      
    <link rel="stylesheet" href="estilogeral.css">
    </head>
    <body>
        <h1>Gerar Grid ASP.NET KENDO</h1>
        <label for="entrada">Cole a classe com namespace (de preferencia TO)C#</label>
        <div class="container">
            <textarea height="50vh" spellcheck="false" id="entrada"></textarea>
        </div>
        
        <div class="container-btn">
            <button onclick="CriarGrid()">Formatar</button>
        </div>

        <label for="saida">Resultado Resx</label>
        <div class="container">
            <textarea height="50vh" spellcheck="false" id="saida"></textarea>
        </div>
    </body>
</html>

<script src="main.js"></script>
<script>

var classe = document.getElementById("entrada");
function Dados(Area,Solution,ControllerName, ClassePrincipal){
    this.Area = Area;
    this.Solution = Solution;
    this.ControllerName = ControllerName;
    this.ClassePrincipal = ClassePrincipal;

    Dados.prototype.Area = () => Area;
    Dados.prototype.Solution = () => Solution;
    Dados.prototype.ControllerName = () => ControllerName;
    Dados.prototype.ClassePrincipal = () => ClassePrincipal;
}

function getNamespace(classe){

var dados = new Dados();
var linhas = classe.split("\n");

for (let indice = 0; indice < linhas.length; indice++) {

    var linha = linhas[indice]; 
    var haNamespace = linha.indexOf("namespace") != -1;

    var haClassName = linha.indexOf("class") != -1;

    if(haNamespace){
        var linhaNamespace = linha.trimLeft().split(".");

        var solutionName = linhaNamespace[0].split(" ")[1];
        var areaName = linhaNamespace[3];
        var controllerName = linhaNamespace[5];

        dados.Area = areaName;
        dados.Solution = solutionName;
        dados.ControllerName = controllerName.replace("{", "");

    }else if(haClassName){
        var mainClassName = linha.trimLeft().split(" ")[2];
        dados.ClassePrincipal = mainClassName;
        return dados;
    }
    
}

return dados;
}

function normalizaClasseName(nome){
    return nome.replace("ViewModel", "").replace("TO", "").replace("{","");
}

function CriarGrid(){
    var classeCompleta     = entrada.value;   
    
    var dados = getNamespace(entrada.value);
    
    var nomeReduzidoClasse = normalizaClasseName(dados.ClassePrincipal);
    var controllerName     = dados.ControllerName;
    var nomeSolucao        = dados.Solution;
    var areaName           = dados.Area; 
    var numeroPropriedades = 10;

    var cabecalho = `
    @using ${nomeSolucao}.Web.Areas.${areaName}.Models.${controllerName}
    @model ${controllerName}ViewModel

    @{
        const string CONTROLLER_NAME = "${controllerName}";
        object AREA = "${controllerName}";
        var estiloColunaInteira      = new { style = "text-align:right" };
        var estiloColunaString       = new { style = "text-align:left" };
        var estiloColunaCentralizada = new { style = "text-align:center" };

        var tamanhoPaginaInicial = 10;
        
        int numeroColunas = ${numeroPropriedades};
        var larguraPorColuna = 100 / numeroColunas;
        var percentualLargura = larguraPorColuna.ToString() + "%";
    }\n\n
    `
    var grid = cabecalho +
    `@(Html.Kendo().Grid<${controllerName}ViewModel>()
        .Name("grid")
        .Pageable(pageable => pageable.
            PageSizes( new int[]{ tamanhoPaginaInicial, tamanhoPaginaInicial *2 , tamanhoPaginaInicial * 3})
        )
        .Columns(cols =>
        {`;
        grid += RetornaColumns(classeCompleta);
        grid += `\n         cols.Command(command =>
        {
            command.Edit();
            command.Destroy();
        }).Width(200);
    })
    .ToolBar(toolbar => toolbar.Create())
    .Editable(editable => editable.Mode(GridEditMode.InLine))
    .DataSource(dataSource => dataSource
        .Ajax()
        .PageSize(tamanhoPaginaInicial)
        .Read(read => read.Action("Read${nomeReduzidoClasse}", CONTROLLER_NAME, AREA}))
        .Create(create => create.Action("Inserir${nomeReduzidoClasse}", CONTROLLER_NAME, AREA}))
        .Update(update => update.Action("Atualizar${nomeReduzidoClasse}", CONTROLLER_NAME, AREA}))
        .Destroy(destroy => destroy.Action("Remover${nomeReduzidoClasse}", CONTROLLER_NAME, AREA}))
    )`

    saida.innerHTML = grid;
    
    copiaAposFormatado();
}

function geraColunaGrid(nomePropriedade, tipoPropriedade, largura = "percentualLargura"){

    console.log(tipoPropriedade);
    var estiloColuna = "estiloColunaCentralizada";
    if(tipoPropriedade == "string"){
        estiloColuna = "estiloColunaString";
    }else if(tipoPropriedade == "int"){
        estiloColuna = "estiloColunaInteira";
    }

    return `\n          cols.Bound(c => c.${nomePropriedade})
                .Width(${largura})
                .Editable("Functions.naoEditavel")
                .HeaderHtmlAttributes(${estiloColuna})
                .HtmlAttributes(${estiloColuna});`;
}

function contemPalavrasIndesejadas(palavra, palavrasIndesejadas){

    var listaPalavrasExcluidas = ["id", "class"];

    listaPalavrasExcluidas.forEach(palavra => {
        var indice = palavra.indexOf("")
    });
}

function RetornaColumns(classe){
    var saida = "";

    var linhas = classe.split("\n");
    for (let index = 0; index < linhas.length; index++) {

        var linha = linhas[index];

        var contemPublic = linha.indexOf("public") != -1;

        if(contemPublic){
            var indicePublic = linha.indexOf("public");

            var contemClass =linha.indexOf("class") != -1;

            if(contemClass){
                continue;
            }

            var nomePropriedade = linha.substr(indicePublic).split(" ")[2];
            var tipoPropriedade = linha.substr(indicePublic).split(" ")[1];

            var larguraColuna = 60;
            saida +=  geraColunaGrid(nomePropriedade, tipoPropriedade) + "\n" ;
        }

    }
    
    return saida;
}

function RetornaColunasGrid(){
    var entradaString = entrada.value;

    const entradaContemValor =  entradaString != undefined;

    if(entradaContemValor){
        var saida = document.getElementById("saida");
        saida.innerHTML = RetornaColumns(entradaString);
    }
}

</script>